# Chat Engine Persistence Layer API

This API defines the endpoints a customer must implement to provide a persistence layer for the Chat Engine. The sole responsibility of this layer is to store and retrieve chat-related information. User authentication and authorization are the responsibilities of the Chat Engine.

The API raises events when the Chat Engine requires some operation from the persistence layer; the persistence layer must implement event handlers with this behavior:
- Read request parameters from the event arguments.
- Execute the requested operation.
- Retrieve the results of successful request completion.
- Return an error code and message in case of exceptions (input argument validation issues, violation of business rules, infrastructure, or unexpected errors).

The API documentation uses .NET (C#) notation. For the sake of brevity, all event argument types inherit from this abstract type, which keeps error-related properties:

```csharp
public abstract class ChatEventArgs : EventArgs
{
  public int ErrorCode { get; set; }
  public string ErrorMessage { get; set; }
}
``` 

The event arguments have read-only properties for input arguments and read-write properties for output values. The initial value of output properties should be considered indeterminate, and each is expected to be set up in the event handler.

## Implementation Semantics

Implementing the persistence interface must keep in mind a few semantic details to ensure the persistence object can seamlessly cooperate with the Chat Engine.

### Conceptual Model

> Here, we describe the conceptual data model. The implementer of the object model may utilize it to create (even a different physical) data model compatible with this one.

![Chat Domain Model](/resources/images/chat-api/domain-model.svg)

#### User

This entity stores information about users. The chat engine does not update the information stored about the user. However, it allows the persistence engine to change user information.

- `id`: Required. Unique ID of the user.
- `displayName`: Required. Full name of the user.
- `firstName`: Required. First name of the user.
- `lastName`: Required. Last name of the user.
- `shortName`: Optional. Short name of the user displayed in mentions.
- `avatartUrl`: Optional. URL to a resource for the user's avatar.
- `roles`: Optional (reserved for future extension). Space-separated values of roles the user has about the Chat App. The app will decide how it uses these roles to manage app permissions, UI, etc.

#### Channel

A channel represents a conversation channel with one or more parties; it keeps the messages and other channel-related system events (invitations, channel joins and exits, etc.).

- `id`: Required. The unique ID of the channel.
- `type`: Required. The type of the channel with one of these values:
- `"direct"`: Direct channel
- `"public"`: Public (topic-specific) channel
- `name`: Optional. The name of the channel. Direct messaging channels do not have a name; however, topic-specific channels must have a name.
- `description`: Optional. The description of the channel.

#### Member

This entity represents a member (communicating party) of a particular channel.

- `channelId`: Required. The ID of the channel this member belongs to.
- `userId`: Required. The ID of the user who is a member in the channel.
- `creator`: Optional. A flag indicating if the member is the creator of the corresponding channel. A channel should have only one creator; this user should not be removed from the channel. (Default: false)
- `roles`: Optional (reserved for future extension). Space-separated values of roles the member has about the corresponding channel. The app will decide how it uses these roles to manage the channel permissions, UI, etc.
- `historyScope`. Optional (reserved for future extension). Serialized data to manage the particular member's visible/hidden messages according to his membership history in the channel.
- `removed`: Required. A flag indicating if the user has been removed from the channel (but once was a member).
- `restricted`: Optional (reserved for future extension). This flag indicates that the user once was a channel member but has been removed permanently.
- `lastModifiedTime`: Optional. The timestamp of the member info's last modification.
- `lastReadMessageId`: Optional. The ID of the latest sent message the particular user has already read in the channel. Messages sent after this one are unread messages.

#### Message

This entity represents a particular message sent to a specific channel. There are two kinds of messages:
1. *User messages* sent by the
2. *System event messages* created by the Chat Engine, for example, when a new user has been invited to a channel.

- `id`: Required. The unique ID of the message. This ID must be a continuously incrementing integer that starts from 1 (or a higher number). ID gaps are accepted.
- `channelID`: Required. The ID of the channel this message belongs to.
- `contentType`: Required. The type of the `contents` field:
- `"text"`: Plain text content
- `contents`: Optional. The message contents serialized into a string.
- `systemEvent`: Optional. System event information serialized into a string.
- `sentBy`: Optional. The ID of the user sending the message. System events do not have a sending user.
- `sentTime`: Required. The timestamp of sending the message.
- `lastEditedTime`: Optional. The timestamp of the last edit.
- `withdrawnTime`: Optional. The timestamp of withdrawal.
- `replyTo`: Optional. The ID of the message to which this one is a reply.

#### Attachment

This entity stores message attachment data.

- `id`: Required. The unique ID of the attachment within the chat system
- `messageId`: Optional. The ID of the message a particular attachment belongs to. Because attachments are uploaded before sending them, this value may be empty.
- `name`: Required. The name of the attachment (as displayed in the UI). Usually, the uploaded attachment's filename.
- `mimeType`: Optional. The mime type of the attachment.
- `size`: Required. The size of the attachment (in bytes).
- `contents`: Optional. The attachment's contents (if stored in the database).
- `uploadedTime`: Required. The timestamp of the attachment upload.

#### Reaction

This entity holds a user's reaction to a particular message.

- `messageId`: Required. The ID of the message this reaction belongs to.
- `userId`: Required. The ID of the reacting user.
- `reaction`: Required. The type of the reaction.

#### ActivityFeed

This entity holds information about user activities the UI utilizes to provide smooth UX.

- `id`: Required. The ID of the activity.
- `topic`: Required. The topic of the activity.
- `type`: Required. The type of the activity.
- `payload`: Required. Data details about the activity.
- `createdTime`: Required. The time the activity feed was created.

### Identifiers

Most entities in the chat engine use strings as unique identifiers within the system (such as users, channels, attachments, and others). However, messages use integers (64-bit integers suggested) for IDs. These IDs should be automatically incremented when inserting a new message, as the Chat Engine uses the fact that a message with a higher ID was created later than another with a smaller ID.

### Optional values

The persistence interface allows the use of optional values. The implementor of the persistence layer should follow this pattern when it wants to sign the empty (unspecified) value for an optional parameter unless specified in a particular API otherwise.

- Integral types: 0 (unless specified in a particular API otherwise)
- Strings: 0 (unless specified in a particular API otherwise)
- Boolean: false 0 (unless specified in a particular API otherwise)
- Timestamps: The empty (or minimum) value of the platform's related timestamp type.

### Event Handler Semantics

The Chat Server uses persistence layer objects to allow a customer to control how chat-related data is stored. The engine ensures that it fires events on a newly instantiated persistence layer object (PLO). When an event handler method runs, it can assume that the PLO has just been initialized.

The engine may fire multiple events when serving a particular endpoint. Customers should implement event handlers as pure methods that do not store any state information outside what they consider the database. Event handlers can only set properties of event arguments or call PLO methods; they must not cause any other side effect (except persisting data).

The following steps describe the flow of using PLO events and methods while serving a particular Chat Server endpoint:
1. The engine prepares to process the incoming request (to execute the API-specific business logic).
2. It creates a new PLO instance and sets the event handlers according to the customer's definition.
3. The engine fires an event on the PLO object to let the associated event handler code run.
4. The event handler gets two input arguments: first, the object representing event arguments; second, the PLO instance.
5. The event handler executes the persistence logic (retrieves or modifies data). It can read and write event argument properties or call the methods of the PLO instance. In case of error, the event handler can set the event argument's `ErrorCode` and `ErrorMessage` properties.
6. When the event handler completes, the engine checks for errors. If the customer's event handler signed an error (the `ErrorCode` event argument property has a non-empty value), the server retrieves an error status code (500 - Internal Error) with the `ErrorCode` (and `ErrorMessage`, provided that is non-empty) in the response body. The API endpoint's operation completes at this point.
7. On successfully completing the event handler method, the engine uses the PLO object instance it created in Step 2 to query and process the event-specific result.
8. The engine may fire other events (as described in Steps 3 to 7) to complete its operation.

According to this flow, these are the possible outcomes of an event handler invocation:

1. Error. The engine recognizes it from the event argument's `ErrorCode` property.
2. Success with no result. The operation has been successfully executed, completing the event handler (with empty `ErrorCode`).
3. Success with a single value results. The operation has been successfully executed, completing the event handler (with empty ErrorCode). The event handler wrote back the result value into a property of the event argument. The engine reads out this value from the event argument object.
4. Success with a compound object results. The operation has been successfully executed, completing the event handler (with empty `ErrorCode`). The event handler called PLO methods to store the event-specific result value. The engine reads out this value from the PLO object.

> The engine considers the PLO event handlers to raise infrastructure errors (like the database is unavailable, some low-level error came back from the persistence layer, and so on). The API endpoints should check for business logic errors before and after invoking event handler methods and not rely on the PLO knowing any business error codes.

## Methods

The persistence layer object provides methods to invoke them in event handlers. These methods are to collect the result from a particular event handler.

All methods accept objects containing a particular entity's properties to store as a (partial) result coming from an event handler method.

All methods return 0 on success and send an error code otherwise.

### AddUser

This method adds a user to an internal list to collect all system users with the `ListUsers` event.

```csharp
public int AddUser(string Id, string DisplayName, string FirstName, string LastName, string ShortName, string AvatarUrl, string Roles);
```

Parameters:

- `Id`: Required. The user's unique identifier within the system.
- `DisplayName`: Required. The user name to display.
- `FirstName`: Optional. The user's first name.
- `LastName`: Optional. The user's last name.
- `ShortName`: Required. The user name to use in mentions.
- `AvatarUrl`: Optional. The URL to the user's avatar.
- `Roles`: Optional (reserved for future extension). Space-separated values of roles the user has about the Chat App. The app will decide how it uses these roles to manage app permissions, UI, etc.

### SetUser

This method saves user information to utilize later when retrieving the result from the `ReadUser` event.

```csharp
public int SetUser(string Id, string DisplayName, string FirstName, string LastName, string ShortName, string AvatarUrl, string Roles);
```

Parameters:

- `Id`: Required. The user's unique identifier within the system.
- `DisplayName`: Required. The user name to display.
- `FirstName`: Optional. The user's first name.
- `LastName`: Optional. The user's last name.
- `ShortName`: Required. The user name to use in mentions.
- `AvatarUrl`: Optional. The URL to the user's avatar.
- `Roles`: Optional (reserved for future extension). Space-separated values of roles the user has about the Chat App. The app will decide how it uses these roles to manage app permissions, UI, etc.

### AddChannel

This method adds a channel to an internal list to collect all channels available by a particular user with the `ListChannels` event.

```csharp
public int AddChannel(string Id, string Type, string Name, string Description);
```

Parameters:

- `Id`: Required. The channel's unique identifier within the system.
- `Type`: Required. The type of the channel determining its membership and available actions.
  - `"direct"`: Private channel of two or more members chatting.
  - `"topic"`: Topic-specific channel (with name). The creator can invite other users, and (as of now) invited users can invite others.
  - Other values may be used in the future.
- `Name`: Optional. The channel's name. It is not required (ignored) for direct channels but must be set for public channels.
- `Description`. Optional. The channel's description; it is ignored for direct channels.

### SetChannel

This method saves channel information to utilize later when retrieving the result from the `ReadChannel` event.

```csharp
public int SetChannel(string Id, string Type, string Name, string Description);
```

Parameters:

- `Id`: Required. The channel's unique identifier within the system.
- `Type`: Required. The type of the channel determining its membership and available actions.
- `"direct"`: Private channel of two or more members chatting.
- `"topic"`: Topic-specific channel (with name). The creator can invite other users, and (as of now) invited users can invite others.
- Other values may be used in the future.
- `Name`: Optional. The channel's name. It is not required (ignored) for direct channels but must be set for public channels.
- `Description`. Optional. The channel's description; it is ignored for direct channels.

### AddChannelMember

This method adds a channel member to an internal list to collect all members with the `ListChannelsMembers` event.


```csharp
public int AddChannelMember(string ChannelId, string UserId, bool Creator, string Roles, string HistoryScope, bool Removed, bool Restricted, DateTime LastModifiedTime, long LastReadMessageId);
```

Parameters:

- `ChannelId`: Required. The channel's unique identifier within the system.
- `UserId`: Required. The member user's unique identifier within the system.
- `Creator`: Required. This flag indicates that the user is the creator of the corresponding channel. (There must be exactly one member user marked with this flag.)
- `Roles`: Optional. The list of member user roles within the channel;  space-separated string with role values (reserved for future extension).
- `HistoryScope`. Optional. The persistence layer should store this value as it is. The engine utilizes this information to display only the available part of the channel history for the user.
- `Removed`: Required. Indicates that the user is removed from the channel. Removed users can still view channel messages (available for them) but cannot send new ones.
- `Restricted`: Required. The restricted users must not view channel messages even if they contributed to them with messages earlier.
- `LastModifiedTime`: The timestamp of the member info's last modification.
- `LastReadMessageId`: Optional. The ID of the latest message the member read.

### SetChannelMember

This method saves channel member information to utilize later when retrieving the result from the `ReadChannelMember` event.


```csharp
public int SetChannelMember(string ChannelId, string UserId, bool Creator, string Roles, string HistoryScope, bool Removed, bool Restricted, DateTime LastModifiedTime, long LastReadMessageId);
```

Parameters:

- `ChannelId`: Required. The channel's unique identifier within the system.
- `UserId`: Required. The member user's unique identifier within the system.
- `Creator`: Required. This flag indicates that the user is the creator of the corresponding channel. (There must be exactly one member user marked with this flag.)
- `Roles`: Optional. The list of member user roles within the channel;  space-separated string with role values (reserved for future extension).
- `HistoryScope`. Optional. The persistence layer should store this value as it is. The engine utilizes this information to display only the available part of the channel history for the user.
- `Removed`: Required. Indicates that the user is removed from the channel. Removed users can still view channel messages (available for them) but cannot send new ones.
- `Restricted`: Required. The restricted users must not view channel messages even if they contributed to them with messages earlier.
- `LastModifiedTime`: The timestamp of the member info's last modification.
- `LastReadMessageId`: Optional. The ID of the latest message the member read.

### AddMessage

This method adds a message to an internal list to collect messages sent to a particular channel with the `ListChannelMessages` event.

```csharp
public int AddMessage(long Id, string ChannelId, string ContentType, string Contents, string SystemEvent, string SentBy, DateTime SentTime,  long ReplyTo, DateTime LastEditedTime, DateTime WithdrawnTime);
```

Parameters:

- `Id`: Required. The message's unique identifier within the system.
- `ChannelId`: Required. The ID of the channel this message was set to.
- `ContentType`: Required. Specifies the type of `contents` (such as `"text"`, `"html"`, `"rtf"`, etc.) to give hints for the UI and the search engine about processing the `contents` field.
- `Contents`: Optional. The string representation of the sent message.
- `SystemEvent`: Optional. The string representation of a system event. (System events are generated by the chat engine, such as "a user has been invited to a channel", etc. These events are stored in the message flow, as they are part of the channel history and displayed there.)
- `SentBy`: Optional. The user's ID who sent this message. In the case of system events, this parameter is empty.
- `SentTime`: Required. The timestamp of sending the message. If the message is a system event, this property contains the event's timestamp.
- `ReplyTo`: Optional. The ID of the message to which the current message is a reply.
- `LastEditedTime`: Optional. The timestamp of the message content's last modification
- `WithdrawnTime`: Optional. The timestamp of deleting the message

### SetMessage

This method saves message information to utilize later when retrieving the result from the `ReadMessage` event.

```csharp
public int SetMessage(long Id, string ChannelId, string ContentType, string Contents, string SystemEvent, string SentBy, DateTime SentTime, long ReplyTo, DateTime LastEditedTime, DateTime WithdrawnTime);
```

Parameters:

- `Id`: Required. The message's unique identifier within the system.
- `ChannelId`: Required. The ID of the channel this message was set to.
- `ContentType`: Required. Specifies the type of `contents` (such as `"text"`, `"html"`, `"rtf"`, etc.) to give hints for the UI and the search engine about processing the `contents` field.
- `Contents`: Optional. The string representation of the sent message.
- `SystemEvent`: Optional. The string representation of a system event. (System events are generated by the chat engine, such as "a user has been invited to a channel", etc. These events are stored in the message flow, as they are part of the channel history and displayed there.)
- `SentBy`: Optional. The user's ID who sent this message. In the case of system events, this parameter is empty.
- `SentTime`: Required. The timestamp of sending the message. If the message is a system event, this property contains the event's timestamp.
- `ReplyTo`: Optional. The ID of the message to which the current message is a reply.
- `LastEditedTime`: Optional. The timestamp of the message content's last modification
- `WithdrawnTime`: Optional. The timestamp of deleting the message

### AddAttachment

This method adds an attachment to an internal list while collecting messages sent to a particular channel with the `ListChannelMessages` event. This method assumes that the message with the specified `MessageId` is already added to the internal list with the `AddMessage` method.

```csharp
public abstract int AddAttachment(string MessageId, string Name, string MimeType, long Size, DateTime UploadedTime);
```

Parameters:

- `MessageId`: Required. The ID of the message to which this attachment belongs.
- `Name`: Required. The name to display for the attachment.
- `MimeType`: Optional. The attachment's mimetype.
- `Size`: Required. The size (in bytes) of the attachment.
- `UploadedTime`: Required. The timestamp of uploading the attachment.

### AddReaction

This method adds an attachment to an internal list while collecting user reactions.

```csharp
public abstract int AddReaction(string MessageId, string UserId, string Reaction);
```

Parameters:

- `MessageId`: Required. The ID of the message to which this reaction belongs.
- `UserId`: Required. The ID of the user reacting to the message.
- `Reaction`: Required. The user's reaction.

### AddActivityFeed

This method adds an activity feed item to an internal list to collect all recent push notification with the `ListActivityFeed` event.

```csharp
public int AddActivityFeed(long Id, string Topic, string Type, string ClientTxId, string Payload, DateTime CreatedTime);
```

Parameters:

- `Id`: Required. The activity feed ID.
- `Topic`: Required. The topic of the activity.
- `Type`: Required. The type of the activity.
- `ClientTxId`: Optional. An identifier that helps the UI to bind this activity with the optimistic UI approach.
- `Payload`: Required. The details of the activity.
- `CreatedTime`: Required. The timestamp of creating the activity feed item.

## Event List

While serving user requests, the Chat Server fires persistence layer object events to retrieve, create, update, or delete data. The persistence object layer should implement event handlers with the semantics described below for each event, respectively.

### ReadUser

The Chat Engine raises this event when it wants to access the up-to-date information of a particular user (e.g., to refresh user data in the UI).

```csharp
public event EventHandler<UserEventArgs> ReadUser;
```
**Semantics**: The implementation must invoke the `SetUser` method with the corresponding user properties.

**Implementation Example**

Event Arguments:

```csharp
{ UserId = "ARN" }
```

SQL Query:

```sql
select * from users where userId = "ARN";
```

**Reference Implementation**

```js
(eventArgs, ploObject) => {
  const u = $db.$users.byId(eventArgs.userId);
  if (u) {
    ploObject.setUser(u.id, u.displayName, u.firstName, u.lastName, u.shortName, u.avatarUrl, u.roles);
  }
}
```

### ListUsers

The Chat Engine raises this event when it wants to access the list of users available within the chat system.

```csharp
public event EventHandler<ChatEventArgs> ListUsers;
```

**Semantics**: The implementation must invoke the `AddUser` method for each user retrieved with the corresponding user properties.

**Implementation Example**

SQL Query:

```sql
select * from users -- optional "where" close to filter out non-chat users;
```

**Reference Implementation**

```js
(eventArgs, ploObject) => {
  $db.$users.toArray().forEach(u => {
    ploObject.addUser(u.id, u.displayName, u.firstName, u.lastName, u.shortName, u.avatarUrl, u.roles);        
  });
}
```

### ReadChannel

The Chat Engine raises this event when it wants to access the up-to-date information of a particular channel (e.g., to refresh channel data in the UI).

```csharp
public event EventHandler<ChannelEventArgs> ReadChannel;
```

**Semantics**: The implementation must invoke the `SetChannel` method for each channel retrieved with the corresponding channel properties.

**Implementation Example**

Event Arguments:

```csharp
{ ChannelId = "A-B" }
```

SQL Query:

```sql
select * from channels where channelId = "A-B";
```

**Reference Implementation**

```js
(eventArgs, ploObject) => {
  const c = $db.$channels.byId(eventArgs.channelId);
  if (c) {
    ploObject.setChannel(c.id, c.type, c.name, c.description);
  }
}
```

### ListUserChannels

The Chat Engine raises this event when it wants to access the available channels for a particular user.

```csharp
public event EventHandler<UserEventArgs> ListUserChannels;
```

**Semantics**: The implementation must invoke the `AddChannel` method with the corresponding channel properties for each channel.

**Implementation Example**

Event Arguments:

```csharp
{ UserId = "JC" }
```

SQL Query:

```sql
select distinc * from channels c
  inner join channelMembers m on c.id = m.channelId
where m.userId = "JC" and m.removed = 0;               
```

**Reference Implementation**

```js
(eventArgs, ploObject) => {
  const { userId } = eventArgs;
  const channelIds = $db.$members.where(m => m.userId === userId).distinctAsArray(m => m.channelId);
  channelIds.map(id => $db.$channels.byId(id)).forEach(c => {
    ploObject.addChannel(c.id, c.type, c.name, c.description);
  });
}
```

### CreateChannel

The Chat Engine raises this event to create a new channel.

```csharp
public event EventHandler<CreateChannelEventArgs> CreateChannel;

public class CreateChannelEventArgs : ChatEventArgs
{
  public string Type { get; }
  public string Name { get; }
  public string Description { get; }
  public string ChannelId { get; set; }
}
```
Event argument properties:

- `Type`: Required. The channel type (direct, public, private, etc.)
- `Name`: Optional. The name of the channel to display.
- `Description`: Optional. The channel's description.
- `ChannelId`: The ID of the newly created channel.

**Semantics**: The event handler should create a new channel record and set the new channel's ID in the `ChannelId` event argument property.

**Implementation Example**

Event Arguments:

```csharp
{ 
  Type = "public",  
  Name = "Sales Info"
}
```

SQL Query:

```sql
insert into channel (type, name)
values ("public", "Sales Info")
select @newId = LAST_INSERT_ID(); -- Send back as ChannelId
```

**Reference Implementation**

```js
(eventArgs) => {
  const { name, type, description } = eventArgs;
  const channel = $db.$channels.insert({
    name,
    type,
    description
  });
  eventArgs.channelId = channel.id;  
}
```

### EditChannel

The Chat Engine raises this event to change the attributes of a particular channel.

```csharp
public event EventHandler<EditChannelEventArgs> EditChannel;

public class EditChannelEventArgs : ChatEventArgs
{
  public string Id { get; }
  public string Name { get; }
  public string Description { get; }
}
```
Event argument properties:

- `Id`: The ID of the channel to edit.
- `Name`: Optional. The name of the channel to display.
- `Description`: Optional. The channel's description.

**Semantics**: The event handler should update a channel record according to the event arguments.

**Implementation Example**

Event Arguments:

```csharp
{ 
  Id = "123",  
  Name = "Sales Info"
}
```

SQL Query:

```sql
update channel
set name="Sales Info"
where id = "123"
```

**Reference Implementation**

```js
(eventArgs) => {
  const { id, name, description } = eventArgs;
  const originalChannel = Assertions.ensureChannel(id);  
  $db.$channels.update({
    ...originalChannel,
    name,
    description
  });
}
```

### ReadChannelMember

The Chat Engine raises this event when it wants to access the up-to-date information of a particular channel member (e.g., use the member data get the ID of the last read message).

```csharp
public event EventHandler<ChannelEventArgs> ReadChannelMember;

public class CreateChannelEventArgs : ChatEventArgs
{
  public string Type { get; }
  public string Name { get; }
  public string Description { get; }
  public string ChannelId { get; set; }
}
```

**Semantics**: The implementation must invoke the `SetChannelMember` method for each member retrieved with the corresponding channel member properties.

**Implementation Example**

Event Arguments:

```csharp
{ ChannelId = "A-B", UserId = "JB" }
```

SQL Query:

```sql
select * from channelMembers where channelId = "A-B" and userId = "JB";
```

**Reference Implementation**

```js
(eventArgs, ploObject) => {
  const { channelId, userId } = eventArgs;
  const m = $db.$members.singleOrDefault(m => m.channelId === channelId && m.userId === userId);
  if (m) {
    ploObject.setChannelMember(m.channelId, m.userId, m.creator, m.roles, m.historyScope, m.removed, m.restricted, 
      m.lastModifiedTime, m.lastReadMessageId);
  }
}
```

### ListChannelMembers

The Chat Engine raises this event when it wants to access the list of member users of a particular channel (see the `ChannelId` event argument).

```csharp
public event EventHandler<ChannelEventArgs> ListChannelMembers;
```

**Semantics**: The implementation must invoke the `AddChannelMember` method with the corresponding channel properties for each member user.

**Implementation Example**

Event Arguments:

```csharp
{ ChannelId = "SAL" }
```

SQL Query:

```sql
select * from channelMemberss where channelId = "SAL";
```

**Reference Implementation**

```js
(eventArgs, ploObject) => {
  const { channelId } = eventArgs;
  const members = $db.$members.where(m => m.channelId === channelId).toArray();
  members.forEach(m => {
    ploObject.addChannelMember(m.channelId, m.userId, m.creator, m.roles, m.historyScope, m.removed, m.restricted, 
    m.lastModifiedTime, m.lastReadMessageId);
  });
}
```

### ListDirectChannels

The Chat Engine raises this event when it wants to access the list of direct channels with a particular membership.

```csharp
public event EventHandler<ListDirectChannelsEventArgs> ListDirectChannels;

public class ListDirectChannelsEventArgs: ChatEventArgs 
{
  string MemberIds { get; }
}
```
Event argument properties:

- `MemberIds`: Required. Space-separated values of user IDs.

**Semantics**: The implementation must retrieve all direct channels with the same active (not removed) users as specified in `MemberIds`. The number of members should match as well each member user IDs.

**Reference Implementation**

```js
(eventArgs, ploObject) => {
  // --- Split space-separated member IDs into a list of numbers
  const memberIds = eventArgs.memberIds.split(" ").map(m => parseInt(m, 10));
    
  if (memberIds.length === 0) {
    // --- No members, no channel
    return result;
  }

  // --- Get all channels of the first user
  const loggedInUsersChannel = $db.$members.where(m => m.userId === memberIds[0]).distinctAsArray(m => m.channelId);
  const directChannels = $db.$channels.where(ch => ch.type === "direct").distinctAsArray(ch => ch.id);
  const channels = directChannels.filter(ch => loggedInUsersChannel.includes(ch));

  // --- Iterate through channels to find the one where members are the same as the invited ones
  for (const channel of channels) {
    // --- Get the user IDs of the members of the channel
    const members = $db.$members.whereAsArray(m => m.channelId === channel && !m.removed).map(m => m.userId);
      
    // --- Step to the next channel if member ID count does not match
    if (members.length !== memberIds.length) {
      continue;
    }
      
    // --- Check if the channel has the same users as invited
    let match = true;
    for (const invited of memberIds) {
      if (!members.includes(invited)) {
        match = false;
        break;
      }
    }

    if (match) {
      // --- This channel matches the list of invited ones
      const c = $db.$channels.byId(channel);
      ploObject.addChannel(c.id, c.type, c.name, c.description);
    }
  }
}
```

### InsertChannelMember

The Chat Engine raises this event to insert a new channel member.

```csharp
public event EventHandler<InsertChannelMemberEventArgs> InsertChannelMembers;

public class InsertChannelMemberEventArgs : ChatEventArgs
{
  public string ChannelId { get; }
  public string UserId { get; }
  public bool Creator { get; }
  public bool Roles { get; }
  public int HistoryScope { get; }
}
```

Event argument properties:

- `ChannelId`: Required. The channel to invite the user.
- `UserId`: Required. The user to invite.
- `Creator`: Required. Is the user the creator of the channel?
- `Roles`: Optional (reserved for future extension). Space-separated values of roles the member in the corresponding channel. The app will decide how it uses these roles to manage app permissions, UI, etc.

**Implementation Example**

Event Arguments:

```csharp
{ 
  Channel = "SAL",  
  UserId = "JC",
  Creator = false,  
}
```

SQL Query:

```sql
insert into channelMembers (channelId, userId, creator)
values ("SAL", "JC", 0)
```

**Reference Implementation**

```js
(eventArgs) => {
  const { 
    channelId, 
    userId, 
    creator, 
    roles, 
    historyScope, 
  } = eventArgs;

  $db.$members.save({
    channelId,
    userId,
    creator,
    roles,
    historyScope,
  });
}
```

### UpdateChannelMember

The Chat Engine raises this event when it wants to update the information of a particular channel's existing member (e.g., the membership information changes, the user is removed, restricted, or invited again, etc.)

```csharp
public event EventHandler<UpdateChannelMemberEventArgs> UpdateChannelMember;

public class UpdateChannelMemberEventArgs : ChatEventArgs
{
  string ChannelId { get; } 
  string UserId { get; }
  bool Creator { get; }
  string Roles { get; }
  string HistoryScope { get; } 
  bool Removed { get; }
  bool Restricted { get; }
  DateTime LastModifiedTime { get; }
  long LastReadMessageId { get; }
}
```

Event argument properties:

- `ChannelId`: Required. The channel to invite the user.
- `UserId`: Required. The user to invite.
- `Creator`: Required. Is the user the creator of the channel?
- `Roles`: Optional (reserved for future extension). Space-separated values of roles the member in the corresponding channel. The app will decide how it uses these roles to manage app permissions, UI, etc.
- `HistoryScope`: Optional. Information about how the messages in the channel should be displayed for the user. The value in this property should be saved exactly as passed.
- `Removed`: Optional. A flag indicating of the user has been removed from the channel.
- `Restricted`: Optional. A flag indicating of the user has been restricted from accessing the channel.
- `LastModifiedTime`: Required. The timestamp of editing the membership information.
- `LastReadMessageId`: Optional. The ID of the last message the user read in this channel.

**Implementation Example**

Event Arguments:

```csharp
{ 
  Channel = "SAL",  
  UserId = "JC",
  Removed = true,
  LastModifiedTime = "2023-01-01T12:23:34.000",
}
```

SQL Query:

```sql
update channelMembers
set removed = 1,
    lastModifiedTime = "2023-01-01T12:23:34.000"
where channelId = "SAL" and "userId" = "JC"
```

**Reference Implementation**

```js
(eventArgs) => {
  const { 
    channelId, 
    userId, 
    creator, 
    roles, 
    historyScope, 
    removed, 
    restricted, 
    lastModifiedTime, 
    lastReadMessageId 
  } = eventArgs;

  $db.$members.save({
    channelId,
    userId,
    creator,
    roles,
    historyScope,
    removed, 
    restricted, 
    lastModifiedTime, 
    lastReadMessageId 
  });
}
```

### ReadMessage

The Chat Engine raises this event when it wants to access the up-to-date information of a particular message (e.g., to refresh message data in the UI).

```csharp
public event EventHandler<MessageEventArgs> ReadMessage;
```

**Semantics**: The implementation must invoke the `SetMessage` method for each message retrieved with the corresponding message properties.

**Implementation Example**

Event Arguments:

```csharp
{ MessageId = 7654 }
```

SQL Query:

```sql
select * from messages where messagId = 7654;
```

**Reference Implementation**

```js
(eventArgs, ploObject) => {
  const m = $db.$messages.byId(eventArgs.messageId);
  if (m) {
    ploObject.setMessage(m.id, m.channelId, m.contentType, m.contents, m.systemEvent, m.sentBy, m.sentTime,
      m.replyTo, m.lastEditedTime, m.withdrawnTime);
  }
}
```

### ReadUnreadMessageCount

The Chat Engine raises this event when it wants to access up-to-date information about the unread messages of a particular user in a specific channel.

```csharp
public event EventHandler<UnreadMessageCountEventArgs> ReadChannelMessageCount;

public class UnreadMessageCountEventArgs : ChatEventArgs
{
  public string ChannelId { get; }
  public string UserId { get; }
  public int MessageCount { get; set; }
}
```

Event argument properties:

- `ChannelId`: The ID of the channel to query
- `UserId`: The ID of the user we check for unread messages
- `MessageCount`: The number of unread messages (return value)

**Implementation Example**

Event Arguments:

```csharp
{ ChannelId = "CH", UserId = "JB" }
```

SQL Query:

```sql
select count(*) from messages 
where 
  sentBy != "JB" 
  and messageId > (
  select lastReadMessageId from channelMembers
  where channelId = "CH" and userId = "JB"
);
```

**Reference Implementation**

```js
(eventArgs, ploObject) => {
  const { channelId, userId } = eventArgs;
  const member = $db.$members.singleOrDefault(m => m.channelId === channelId && m.userId === userId);
  const unread = $db.$messages.whereAsArray(
    m => m.channelId == channelId && m.id > (member.lastReadMessageId ?? 0) && m.sentBy !== userId);
  eventArgs.messageCount = unread.length; 
}
```

### MarkAsLastRead

The engine raises this event when it is time to mark a particular message as the last read by a specific user.

```csharp
public event EventHandler<MarkAsLastReadEventArgs> MarkAsLastRead;

public class MarkAsLastReadEventArgs : ChatEventArgs
{
  public long MessageId { get; }
  public string UserId { get; }
}
```

Event argument properties:

- `MessageId`: The ID of the message to mark
- `UserId`: The ID of the user who read the marked message

**Implementation Example**

Event Arguments:

```csharp
{ MessageId = 1234, UserId = "JB" }
```

SQL Query:

```sql
update channelMembers
set lastReadMessageId = 1234
where 
  userId == "JB" 
  and channelId = (select channelId from messages where messageId = 1234);
```

**Reference Implementation**

```js
(eventArgs) => {
  const { messageId, userId } = eventArgs;
  const message = Assertions.ensureMessage(messageId);
  const existingMember = $db.$members
    .singleOrDefault(m => m.channelId === message.channelId && m.userId === userId);
  existingMember.lastReadMessageId = parseInt(messageId, 10);
  $db.$members.save(existingMember);
}
```

### ListChannelMessages

This method queries a segment of messages from the channel's message history. It retrieves only a window of messages (according to the caller's request).

```csharp
public event EventHandler<ChannelMessagesEventArgs> ListChannelMessages;

public class ChannelMessagesEventArgs : ChatEventArgs
{
  public string ChannelId { get; }
  public long Before { get; }
  public long After { get; }
  public bool Inclusive { get; }
  public int Count { get; }
}
```

Event argument properties:

- `ChannelId`: The ID of the channel to query
- `Before`: A negative value means this property is empty. Otherwise, it signs the ID of the first message to get the specified window of messages **sent before** the message with this ID. The messages should be retrieved in descending order by their IDs.
- `After`: A negative value means this property is empty. Otherwise, it signs the ID of the first message to get the specified window of messages **sent after** the message with this ID. The messages should be retrieved in ascending order by their IDs.
- `Inclusive`: This flag signs (the `true` value) that the message with the ID specified in `Before` or `After` should be retrieved in the query. The `false` value signs that those messages should be skipped.
- `Count`: The maximum number of messages to retrieve in the query.

**Semantics**:

When this event is fired, the engine sets either `Before` or `After` to a non-empty value, but never both. The engine never raises an event with both `Before` and `After` set to an empty value.

**This method should retrieve withdrawn messages (marked with the `Withdrawn` flag) and system event messages, too.**

The implementation must invoke the `AddMessage` method for each message to return, the `AddAttachment` method to collect attachments bound to a particular message, and the `AddReaction` method to gather message reactions.

**Implementation Example**

Let's assume we have messages with IDs from 1 to 8 for a particular channel (with the ID of "CH"). Also, assume the channel messages are in a database table called `Message`. These are the SQL queries the event handlers should run for a particular request (with their results):

*Example #1:*

Event Arguments:

```csharp
{ ChannelId = "CH", Before = 8, After = -1, Inclusive = true, Count = 3 }
```

SQL Query:

```sql
select top 3 * from messages 
where channelId = "CH" and id <= 8
order by id desc
```

Result: messages with IDs 8, 7, 6

*Example #2:*

Event Arguments:

```csharp
{ ChannelId = "CH", Before = 6, After = -1, Inclusive = false, Count = 4 }
```

SQL Query:

```sql
select top 4 * from messages 
where channelId = "CH" and id < 6
order by id desc
```

Result: messages with IDs 5, 4, 3, 2

*Example #3:*

Event Arguments:

```csharp
{ ChannelId = "CH", Before = -1, After = 3, Inclusive = true, Count = 3 }
```

SQL Query:

```sql
select top 3 * from messages 
where channelId = "CH" and id >= 3
order by id
```

Result: messages with IDs 3, 4, 5

*Example #4:*

Event Arguments:

```csharp
{ ChannelId = "CH", Before = -1, After = 5, Inclusive = false, Count = 15 }
```

SQL Query:

```sql
select top 15 * from messages 
where channelId = "CH" and id > 5
order by id
```

Result: messages with IDs 6, 7, 8

**Reference Implementation**

```js
(eventArgs, ploObject) => {
  // --- Get the properties of the event argument
  const { channelId, before, after, inclusive, count } = eventArgs;
    
  // --- The query that gets messages according to the API parameters.
  // --- It uses the database/persistence object of the customer
  let messages;
  if (before > 0) {
    messages = $db.$messages
      .where(m => m.channelId === channelId && (inclusive ? m.id <= before : m.id < before))
      .orderBy(m => -m.id)  // --- descending order, latest first
      .take(count);    
  } else if (after > 0) {
    messages = $db.$messages
      .where(m => m.channelId === channelId && (inclusive ? m.id >= after : m.id > after))
      .orderBy(m => m.id)  // --- ascending order, latest last
      .take(count);     
  }

  // --- Iterate through the queried object and 
  messages.toArray().forEach((m) => {
    // --- Collect the message
    ploObject.addMessage(m.id, m.channelId, m.contentType, m.contents, m.systemEvent, m.sentBy, m.sentTime,
  m.replyTo, m.lastEditedTime, m.withdrawnTime);
  });
}
```

### ListReactions

The Chat Engine raises this event when it wants to access the list of reactions for a particular message.

```csharp
public event EventHandler<MessageEventArgs> ListReactions;
```

**Semantics**: The implementation must invoke the `AddReaction` method with the corresponding reaction properties.

**Implementation Example**

Event Arguments:

```csharp
{ MessageId = 768 }
```

SQL Query:

```sql
select * from reactions where messageId == 768 
```

**Reference Implementation**

```js
(eventArgs, ploObject) => {
  const messageId = parseInt(eventArgs.messageId, 10);
  const reactions = $db.$reactions.where(r => r.messageId === messageId).toArray();
  reactions.forEach(r => ploObject.addReaction(r.messageId, r.userId, r.reaction));
}
```

### ListAttachments

The Chat Engine raises this event when it wants to access the list of attachments for a particular message.

The implementation must invoke the `AddAttachment` method with the corresponding channel properties for each member user.

```csharp
public event EventHandler<MessageEventArgs> ListReactions;
```

**Semantics**: The implementation must invoke the `AddAttachment` method with the corresponding attachment properties.

**Implementation Example**

Event Arguments:

```csharp
{ MessageId = 256 }
```

SQL Query:

```sql
select * from attachments where messageId == 256 
```

**Reference Implementation**

```js
(eventArgs, ploObject) => {
  const messageId = parseInt(eventArgs.messageId, 10);
  const attachments = $db.$attachments.where(r => r.messageId === messageId).toArray();
  attachments.forEach(a => 
    ploObject.addAttachment(a.id, a.messageId, a.name, a.mimeType, a.size, a.uploadedTime, a.file));
}
```

### SendMessage

The Chat Engine raises this event to send a new message to a particular channel.

The `AttachmentIds` property is a space-separated string of the attachment IDs bound to the new message.

```csharp
public event EventHandler<SendMessageEventArgs> SendMessage;

public class SendMessageEventArgs : ChatEventArgs
{
  public string ChannelId { get; }
  public string ContentType { get; }
  public string Contents { get; }
  public string SystemEvent { get; }
  public string SentBy { get; }
  public DateTime SentTime { get; }
  public string ReplyToMessageId { get; }
  public string AttachmentIds { get; }
  public long SentMessageId { get; set; }
}
```

Event argument properties:

- `ChannelId`: Required. The ID of the channel this message was set to.
- `ContentType`: Required. Specifies the type of `contents` (such as `"text"`, `"html"`, `"rtf"`, etc.) to give hints for the UI and the search engine about processing the `contents` field.
- `Contents`: Optional. The string representation of the sent message.
- `SystemEvent`: Optional. The string representation of a system event. (System events are generated by the chat engine, such as "a user has been invited to a channel", etc. These events are stored in the message flow, as they are part of the channel history and displayed there.)
- `SentBy`: Optional. The user's ID who sent this message. In the case of system events, this parameter is empty.
- `SentTime`: Required. The timestamp of sending the message. If the message is a system event, this property contains the event's timestamp.
- `ReplyTo`: Optional. The ID of the message to which the current message is a reply.
- `AttachmentIds`: Optional. Space-separated values of attachment IDs bound to this message.

**Semantics**: Message IDs should be continuously incremented integers; they may have gaps. A message with a higher ID is considered to have been sent later than another one with a smaller ID. Message IDs must be unique within the system, not just within a particular channel.

Attachments are considered to be uploaded before this event. The event handler should bind the attachments to the newly sent message.

**Creating a new message and binding attachments should be an atomic database transaction.**

The ID of the new message must be retrieved in the `SentMessageId` event argument property.

**Implementation Example**

Event Arguments:

```csharp
{ 
  ChannelId = "CH",
  ContentType = "text",
  Contents = "Hello!",
  SentBy = "JB",
  SentTime = "2023-01-01T12:23:34.000",
  AttachmentIds = "A B"  
}
```

SQL Query:

```sql
begin transaction
  insert into messages (channelId, contentType, contents, sentBy, sentTime)
  values ("CH", "text", "Hello!", "JB", "2023-01-01T12:23:34.000");
  select @newId = LAST_INSERT_ID();    
  update attachments set messageId = @newId where id = "A"
  update attachments set messageId = @newId where id = "B"
commit transaction
```

**Reference Implementation**

```js
(eventArgs) => {
  const { channelId, contentType, contents, systemEvent, replyTo, sentBy, attachmentIds } = eventArgs;
    
  // --- Split the ID list into separate IDs
  const attachedIdsSplit = attachmentIds.split(" ");
    
  // --- We store the inserted message record here
  let inserted;
    
  // --- Insert the new message and update the attachments in a transaction
  $db.transaction(() => {
    // --- Assemble the new message
    const toInsert = {
      channelId,
      contentType: contentType ?? "text",
      sentTime: $env.getDate().toISOString(),
    }
    if (contents) toInsert.contents = contents;
    if (systemEvent) toInsert.systemEvent = systemEvent;
    if (replyTo) toInsert.replyTo = replyTo;
    if (sentBy) toInsert.sentBy = sentBy;

    inserted = $db.$messages.insert(toInsert);
    
    // --- Bind previously updated attachments to this message
    if (attachmentIds) {
      attachedIdsSplit.forEach((attachmentId) => {
        const attachment = $db.$attachments.byId(attachmentId);
        $db.$attachments.update({...attachment, messageId: inserted.id});              
      });
    }
  });
    
  // --- Done
  eventArgs.sentMessageId = inserted.id;
}
```

### EditMessage

The Chat Engine raises this event to update an already sent message.

```csharp
public event EventHandler<EditMessageEventArgs> EditMessage;

public class EditMessageEventArgs : ChatEventArgs
{
  public long MessageId { get; }
  public string ContentType { get; }
  public string Contents { get; }
  public DateTime LastEditedTime { get; }
  public string AttachmentIds { get; }
}
```

Event argument properties:

- `MessageId`: Required. The ID of the message edited.
- `ContentType`: Required. Specifies the type of `contents` (such as `"text"`, `"html"`, `"rtf"`, etc.) to give hints for the UI and the search engine about processing the `contents` field.
- `Contents`: Optional. The string representation of the sent message.
- `LastEditedTime`: Required. The timestamp of editing the message.
- `AttachmentIds`: Optional. Space-separated values of attachment IDs bound to this message.

**Semantics**: Attachments are considered to be uploaded before this event. The event handler should bind new attachments to the updated message and remove the old attachments (not bound to the message anymore).

**Editing a message and binding attachments should be an atomic database transaction.**

**Implementation Example**

Event Arguments:

```csharp
{ 
  MessageId = 423,
  ContentType = "text",
  Contents = "Hi, again!",
  LastEditedTime = "2023-01-01T12:23:34.000",
  AttachmentIds = "C D"  
}
```

SQL Query:

```sql
begin transaction
  update messages 
  set contentType = "text",
      contents = "Hi, again!",
      lastEditedTime = "2023-01-01T12:23:34.000"
  where id = 423;
  update attachments
  set messageId = null
  where messageId = 423
  update attachments set messageId = 423 where id = "C"
  update attachments set messageId = 423 where id = "D"
commit transaction
```

**Reference Implementation**

```js
(eventArgs) => {
  const { messageId, contentType, contents, lastEditedTime, attachmentIds } = eventArgs;
  const originalMessage = Assertions.ensureCreatorOfMessage(messageId);
  const modifiedMessage = {
    ...originalMessage,
    contentType,
    contents,
    lastEditedTime
  }
    
  $db.transaction(() => {
    const modified = $db.$messages.update(modifiedMessage);
    
    // --- Remove the old message attachments
    const existingAttachments = $db.$attachments.where(
      (attachment) => attachment.messageId === originalMessage.id).toArray();
    existingAttachments.forEach((attachment) => {
      $db.$attachments.update({...attachment, messageId: null});
    });
    
    // --- Bind the new attachments
    if (!!attachmentIds) {
      const attachedFileIds = attachmentIds.split(" ");
      attachedFileIds.forEach((fileId) => {
        const file = $db.$attachments.byId(fileId);
        $db.$attachments.update({...file, messageId: modified.id});              
      });
    }
  });  
}
```

### WithdrawMessage

The Chat Engine raises this event to withdraw an already sent message.

**Semantics**: The event handler should only mark the withdrawn message with a flag, as withdrawn messages should be retrieved, too, when querying channel history.

```csharp
public event EventHandler<WithdrawMessageEventArgs> WithdrawMessage;

public class WithdrawMessageEventArgs : ChatEventArgs
{
  public long MessageId { get; }
  public DateTime WithdrawnTime { get; }
}
```

Event argument properties:

- `MessageId`: Required. The ID of the message to withdraw.
- `WithdrawnTime`: Required. The timestamp of deleting the message.

**Semantics**: The event handler should only mark the withdrawn message with a flag, as withdrawn messages should be retrieved, too, when querying channel history.

**Implementation Example**

Event Arguments:

```csharp
{ 
  MessageId = 114,
  WithdrawnTime = "2023-01-01T12:23:34.000",
}
```

SQL Query:

```sql
update messages 
set withdrawnTime = "2023-01-01T12:23:34.000"
where id = 114;
```

**Reference Implementation**

```js
(eventArgs) => {
   const { messageId, withdrawnTime } = eventArgs
       
   const message = Assertions.ensureCreatorOfMessage(messageId);
   message.withdrawnTime = withdrawnTime;
   $db.$messages.update(message);
}
```

### ReactToMessage

The Chat Engine raises this event when a user adds or removes a reaction to a particular message.

```csharp
public event EventHandler<ReactToMessageEventArgs> ReactToMessage;

public class ReactToMessageEventArgs : ChatEventArgs
{
  public long MessageId { get; }
  public string UserId { get; }
  public string Reaction { get; }
}
```
Event argument properties:

- `MessageId`: Required. The ID of the message the user reacts.
- `UserId`: Required. The ID of the user reacting to the message.
- `Reaction`: The reaction to add to the message.

**Semantics**: When `Reaction` is empty (null, empty string, or whitespaces only), the existing reaction should be removed from the message; otherwise, it should be added. A user can have zero or one reaction to a particular message.

**Implementation Example**

Event Arguments:

*Example #1*

```csharp
{ 
  MessageId = 241,
  UserID = "AL",
  Reaction = "like"  
}
```

SQL Query:

```sql
begin transaction
delete from reactions 
where messageId = 241 and userId = "AL";
insert into reactions (messageId, userId, reaction)
values (241, "AL", "like");    
commit transaction
```

*Example #2*

```csharp
{ 
  MessageId = 241,
  UserID = "AL",
  Reaction = null // or "", "   ", etc.  
}
```

SQL Query:

```sql
delete from reactions 
where messageId = 241 and userId = "AL";
```

**Reference Implementation**

```js
(eventArgs) => {
  const { messageId, userId, reaction } = eventArgs
    
  const message = Assertions.ensureMessage(messageId);
  Assertions.ensureMemberOfChannel(message.channelId);
    
  if (!reaction) {
    // --- Remove the existing reaction
    $db.$reactions.deleteById([messageId, userId]);
  } else {
    // --- Save the new reaction
    $db.$reactions.save({messageId, userId, reaction});
  }
}
```

### UploadAttachment

The Chat Engine raises this event when it uploads an attachment (not bound to any message yet).

```csharp
public event EventHandler<UploadAttachmentEventArgs> UploadAttachment;

public class UploadAttachmentEventArgs : ChatEventArgs
{
    public string Filename { get; }
    public string MimeType { get; }
    public int Size { get; }
    public DateTime UploadedTime { get; }
    public Stream Contents { get; }
    public string UploadedAttachmentId { get; set; }
}
```

Event argument properties:

- `FileName`: Required. The name of the attachment file uploaded.
- `MimeType`: Optional. The type of the attachment.
- `Size`: Required. The size of the uploaded attachment file.
- `UploadedTime`: Required. The timestamp of the upload operation.
- `Contents`: Required. The attachment file stream.
- `UploadedAttachmentId`: The ID of the newly uploaded attachment (return value)

**Semantics**: An attachment should be uploaded before it can be assigned to a message (with `SendMessage` or `EditMessage`). The server does not care about orphan attachments (uploaded but not bound to any message).

**Implementation Example**

Event Arguments:

*Example #1*

```csharp
{ 
  FileName = "Agenda.docx,
  MimeType = "docx",
  Size = 82145,
  UploadedTime = "2023-01-01T12:23:34.000",
  Contents = stream  
}
```

SQL Query:

```sql
insert into attachments (filename, mimetype, size, uploadedTime)
values ("Agenda.doc", "docx", 82145, "2023-01-01T12:23:34.000");
select @newAttachmentId = LAST_INSERTED_ID();
```

(Of course, the stream also should be stored.)

**Reference Implementation**

```js
(eventArgs) => {
  const { filename, mimeType, size, uploadedTime, contents } = eventArgs;
         
  const storedFile = $db.$attachments.insert({
    name: filename,
    mimeType,
    size,
    uploadedTime,
    file: contents
  });
  eventArgs.uploadedAttachmentId = storedFile.id;
}
```

### DownloadAttachment

The Chat Engine raises this event when it downloads an attachment.

```csharp
public event EventHandler<DownloadAttachmentEventArgs> DownloadAttachment;

public class DownloadAttachmentEventArgs : ChatEventArgs
{
  public string AttachmentId { get; }
}
```

**Semantics**: The implementation must invoke the `SetAttachment` method with the attachment stream.

**Reference Implementation**

```js
(eventArgs, ploObject) => {
  const { attachmentId } = eventArgs;
  ploObject.setContents($db.$attachments.byId(attachmentId).file)
}
```

### CreateActivityFeed

The Chat Engine raises this event when it stores a particular user activity the chat app utilizes to update the UI (of other users) accordingly.

```csharp
public event EventHandler<CreateActivityFeedEventArgs> CreateActivityFeed;

public class CreateActivityFeedEventArgs : ChatEventArgs
{
  public string Id { get; } 
  public string Topic { get; }
  public string Type { get; }  
  public string Payload { get; }
  public string ClientTxId { get; }  
  public DateTime CreatedTime { get; }  
}
```

Event argument properties:

- `Id`: Required. Unique activity identifier. The Chat Engine generates IDs that can be compared with the invariant culture. The greater the ID, the later the message was sent.
- `Topic`: Required. The chat engine provides a topic for each activity feed item. The UI uses this value to decide how it processes a particular activity.
- `Type`: Required. The chat engine provides a type for each activity feed item. The UI uses this value to decide how it processes a particular activity.
- `ClientTxId`: Optional. An identifier that helps the UI to bind this activity with the optimistic UI approach.
- `Payload`: Optional. The details of the activity feed.
- `CreatedTime`: Required. The timestamp of creating the activity item.

**Semantics**: The event handler should create a new activity feed record using the provided event properties.

**Implementation Example**

Event Arguments:

```csharp
{ 
  Id = "abc-1234",  
  Topic = "user_12",
  Type = "ChannelCreated",
  ClientTxId = "12345",    
  Payload = "{ channelId: 24 }",
  CreatedTime = "2023-01-01T12:23:34.000",
}
```

SQL Query:

```sql
insert activityFeed (id, topic, type, clientTxId, payload, createdTime)
value ("abc-1234", "user_12", "ChannelCreated", "12345", "{ channelId: 24 }", "2023-01-01T12:23:34.000")
```

**Reference Implementation**

```js
(eventArgs) => {
  const {topic, type, createdTime, payload, clientTxId} = eventArgs;
  $db.$activityFeed.native().add({
    topic,
    type,
    createdTime,
    payload,
    clientTxId
  });
}
```

### ListActivityFeed

The Chat Engine raises this event to retrieve the activity feed items created.

```csharp
public event EventHandler<ListActivityFeedEventArgs> ListActivityFeed;

public class ListActivityFeedEventArgs : ChatEventArgs
{
  public string Topic { get; } 
  public string LastId { get; }
  public string Count { get; }
}
```

Event argument properties:

- `Topic`: Required. The topic of feed items to retrieve.
- `LastId`: Required. The last message ID processed by the caller.
- `Count`: Required. The maximum number of activity feed items to retrieve.

**Semantics**: The implementation should return the *latest* activity feed items sent after the one specified by the `LastId` event argument property. Only the top `Count` notification should be retrieved in descending order.

The implementation must invoke the `AddActivityFeed` method for each message to return.

**Implementation Example**

Event Arguments:

```csharp
{ 
  Topic = "channel_4",  
  LastId = "abc-23",
  Count = 10,
}
```

SQL Query:

```sql
select top 10 * from activityFeed
where topic = "channel_4" & lastId > "abc-23"
order by lastId desc
```

**Reference Implementation**

```js
(eventArgs, ploObject) => {
  const {topic, lastId, count} = eventArgs;
    
  let items = $db.$activityFeed.native().where("topic").equals(topic).reverse()
    .limit(count).toArray().reverse();
  if (lastId) {
    items = items.filter(item => item.id > lastId);
  }
  items.forEach((f) => {
    ploObject.addActivityFeed(f.id, f.topic, f.type, f.clientTxId, f.payload, f.createdTime);
  });
}
```

### DeleteActivityFeed

The Chat Engine raises this event to remove the outdated part of the activity feed items. This event is expected to remove up to a few hundred items, usually a few dozen.

```csharp
public event EventHandler<DeleteActivityFeedEventArgs> DeleteActivityFeed;

public class DeleteActivityFeedEventArgs : ChatEventArgs
{
  public DateTime Before { get; }  
}
```

Event argument properties:

- `Before`: Required. Activity feed items before this timestamp should be deleted.

**Semantics**: The event handler should delete all activity feed items created before the specified `Before` timestamp (in a single transaction).

**Implementation Example**

Event Arguments:

```csharp
{ 
  Expired = "2022-01-01T12:23:34.000",
}
```

SQL Query:

```sql
delete from activityFeed
where createdTime < "2022-01-01T12:23:34.000"
```

**Reference Implementation**

```js
(eventArgs) => {
  const {before} = eventArgs;
  $db.$activityFeed.native().where("createdTime").below(before).delete();
}
```

## Event Arguments

An event arguments object is passed to a particular event handler method. If that event handler produces a single value result (such as an integer number), it is passed back through an event argument property.

### UserEventArgs

This event argument is passed to events that retrieve user information.

```csharp
public class UserEventArgs : ChatEventArgs
{
  public string UserId { get; }
}
```

### ChannelEventArgs

This event argument is passed to events that retrieve channel information.

```csharp
public class ChannelEventArgs : ChatEventArgs
{
  public string ChannelId { get; }
}
```

### ChannelMemberEventArgs

This event argument is passed to events that retrieve channel member information.

```csharp
public class ChannelMemberEventArgs : ChatEventArgs
{
  public string ChannelId { get; }
  public string UserId { get; }
}
```

### MessageEventArgs

This event argument is passed to events that retrieve message information.

```csharp
public class MessageEventArgs : ChatEventArgs
{
  public long MessageId { get; }
}
```

### ChannelMessagesEventArgs

This event argument is passed to events that retrieve a segment of messages.

```csharp
public class ChannelMessagesEventArgs : ChatEventArgs
{
  public string ChannelId { get; }
  public long Before { get; }
  public long After { get; }
  public bool Inclusive { get; }
  public int Count { get; }
}
```

### UnreadMessageCountEventArgs

This event argument is passed to events that retrieve unread message count information.

```csharp
public class UnreadMessageCountEventArgs : ChatEventArgs
{
  public string ChannelId { get; }
  public string UserId { get; }
  public int MessageCount { get; set; }
}
```

### MarkAsLastReadEventArgs

This event argument is passed to events that save last read message information.

```csharp
public class MarkAsLastReadEventArgs : ChatEventArgs
{
  public long MessageId { get; }
  public string UserId { get; }
}
```

### SendMessageEventArgs

This event argument is used by the `SendMessage` event handler.

```csharp
public class SendMessageEventArgs : ChatEventArgs
{
  public string ChannelId { get; }
  public string ContentType { get; }
  public string Contents { get; }
  public string SystemEvent { get; }
  public string SentBy { get; }
  public DateTime SentTime { get; }
  public string ReplyToMessageId { get; }
  public string AttachmentIds { get; }
  public long SentMessageId { get; set; }
}
```

### EditMessageEventArgs

This event argument is used by the `SendMessage` event handler.

```csharp
public class EditMessageEventArgs : ChatEventArgs
{
  public long MessageId { get; }
  public string ContentType { get; }
  public string Contents { get; }
  public DateTime LastEditedTime { get; }
  public string AttachmentIds { get; }
}
```

### WithdrawMessageEventArgs

This event argument is used by the `WithdrawMessage` event handler.

```csharp
public class WithdrawMessageEventArgs : ChatEventArgs
{
  public long MessageId { get; }
  public DateTime WithdrawnTime { get; }
}
```

### ReactToMessageEventArgs

This event argument is used by the `ReactToMessage` event handler.

```csharp
public class ReactToMessageEventArgs : ChatEventArgs
{
  public long MessageId { get; }
  public string UserId { get; }
  public string Reaction { get; }
}
```

### UploadAttachmentEventArgs

This event argument is used by the `UploadAttachment` event handler.

```csharp
public class UploadAttachmentEventArgs : ChatEventArgs
{
    public string Filename { get; }
    public string MimeType { get; }
    public int Size { get; }
    public DateTime UploadedTime { get; }
    public Stream Contents { get; }
    public string UploadedAttachmentId { get; set; }
}
```

### DownloadAttachmentEventArgs

This event argument is used by the `DownloadAttachment` event handler.

```csharp
public class DownloadAttachmentEventArgs : ChatEventArgs
{
  public string AttachmentId { get; }
}
```

### InsertChannelMemberEventArgs

This event argument is used by the `InsertChannelMember` event handler.

```csharp
public class InsertChannelMemberEventArgs : ChatEventArgs
{
  public string ChannelId { get; }
  public string UserId { get; }
  public bool Creator { get; }
  public bool Roles { get; }
  public int HistoryScope { get; }
}
```

### UpdateChannelMemberEventArgs

This event argument is used by the `UpdateChannelMember` event handler.

```csharp
public class UpdateChannelMemberEventArgs : ChatEventArgs
{
  string ChannelId { get; } 
  string UserId { get; }
  bool Creator { get; }
  string Roles { get; }
  string HistoryScope { get; } 
  bool Removed { get; }
  bool Restricted { get; }
  DateTime LastModifiedTime { get; }
  long LastReadMessageId { get; }
}
```

### ListDirectChannelsEventArgs

This event argument is used by the `ListDirectChannels` event handler.

```csharp
public class ListDirectChannelsEventArgs: ChatEventArgs 
{
  string MemberIds { get; }
}
```

### CreateChannelEventArgs

This event argument is used by the `CreateChannel` event handler.

```csharp
public class CreateChannelEventArgs : ChatEventArgs
{
  public string Type { get; }
  public string Name { get; }
  public string Description { get; }
  public string ChannelId { get; set; }
}
```

### CreateActivityFeedEventArgs

This event argument is used by the `CreateActivityFeed` event handler.

```csharp
public class CreateActivityFeedEventArgs : ChatEventArgs
{
  public string Id { get; } 
  public string Topic { get; }
  public string Type { get; }  
  public string ClientTxId { get; }  
  public string Payload { get; }
  public DateTime CreatedTime { get; }  
}
```

### EditChannelEventArgs

This event argument is used by the `EditChannel` event handler.

```csharp
public class EditChannelEventArgs : ChatEventArgs
{
  public string Id { get; }
  public string Name { get; }
  public string Description { get; }
}
```

### ListActivityFeedEventArgs

This event argument is used by the `ListActivityFeed` event handler.

```csharp
public class ListActivityFeedEventArgs : ChatEventArgs
{
  public string Topic { get; } 
  public string LastId { get; }
  public string Count { get; }
}
```

### DeleteActivityFeedEventArgs

This event argument is used by the `DeleteActivityFeed` event handler.

```csharp
public event EventHandler<DeleteActivityFeedEventArgs> DeleteActivityFeed;

public class DeleteActivityFeedEventArgs : ChatEventArgs
{
  public DateTime Before { get; }  
}
```
