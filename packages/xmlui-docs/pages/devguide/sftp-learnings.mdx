# SFTP Learnings

I share what I learned from the SFTP app review in this article. I used the `create-xmlui-app` to create a new XMLUI app and copied the `src` and `resources` folders of the zip file I received.

## 1. Creating a new SftpHeader component

The initial source code contains a pretty long code for the `AppHeader`, which is a bit distracting:

```ueml copy
<App layout="vertical-sticky">
  <AppHeader>
    <Button 
      var.serverState=""
      id="serverActionButton"
      type="button"
      horizontalMargin="0.25rem"
      icon="{serverState == 'running' ? 'stop' : 'start'}" >
      <event name="click">
          <ApiBinding 
            url="/server/action"
            method="post"
            body="{{ serverAction: (state == 'running') ? 'stop' : 'start' }}"
            inProgressNotificationMessage="{(serverState == 'running' ? 'Stopping' : 'Starting') + ' server ...'}"
            onSuccess="{ serverState = (serverState == 'running' ? '' : 'running') }"/>
      </event>
      {serverState == "running" ? "Stop" : "Start"}
    </Button>
    <Button 
      var.serverState=""
      id="serverActionButton"
      type="button"
      horizontalMargin="0.25rem"
      icon="restart" >
      <event name="click">
          <ApiBinding 
            url="/server/action"
            method="post"
            body="{{ serverAction: 'restart' }}"
            onSuccess="() => { serverState = state; }"/>
      </event>
      Restart
    </Button>
    <Checkbox label="Run as service" id="runAsService" initialValue="false" padding="1rem" />
  </AppHeader>

  <!-- Code omitted for brevity -->

</App>  
```

This header is not just some static information; it handles state. We suggest moving such stateful parts into their separate component:

```ueml copy
<Component name="SftpHeader">
  <Button 
    var.serverState=""
    id="serverActionButton"
    type="button"
    horizontalMargin="0.25rem"
    icon="{serverState == 'running' ? 'stop' : 'start'}" >
    <event name="click">
      <ApiBinding 
        url="/server/action"
        method="post"
        body="{{ serverAction: (state == 'running') ? 'stop' : 'start' }}"
        inProgressNotificationMessage="{(serverState == 'running' ? 'Stopping' : 'Starting') + ' server ...'}"
        onSuccess="{ serverState = (serverState == 'running' ? '' : 'running') }"/>
    </event>
    {serverState == "running" ? "Stop" : "Start"}
  </Button>
  <Button 
    var.serverState=""
    id="serverActionButton"
    type="button"
    horizontalMargin="0.25rem"
    icon="restart" >
    <event name="click">
      <ApiBinding 
        url="/server/action"
        method="post"
        body="{{ serverAction: 'restart' }}"
        onSuccess="() => { serverState = state; }"/>
    </event>
    Restart
  </Button>
  <Checkbox label="Run as service" id="runAsService" initialValue="false" padding="1rem" />
</Component>
```

In the `AppHeader`, we refer to the extracted component:

```ueml copy
<App layout="vertical-sticky">
  <AppHeader>
    <SftpHeader /> 
  </AppHeader>

  <!-- Code omitted for brevity -->

</App>  
```

## 2. Fixing the header's state-management bug

The `SftpHeader` embeds two buttons and a checkbox. It intends to store the server's state (started/stopped) but has a bug: it has two separate `serverState` variables, one-one in each `Button`:

```ueml copy {3, 7}
<Component name="SftpHeader">
  <Button <!-- Start/Stop -->
    var.serverState=""
    <!-- Code omitted -->
  </Button>
  <Button <!-- Restart -->
    var.serverState=""
    <!-- Code omitted -->
  </Button>
  <Checkbox label="Run as service" id="runAsService" initialValue="false" padding="1rem" />
</Component>
```

Move the `serverState` variable to the `SftpHeader` component to remove this duality, and fix the response handling error in the Refresh button:

```ueml copy {1, 29}
<Component name="SftpHeader" var.serverState="">
  <Button 
    id="serverActionButton"
    type="button"
    horizontalMargin="0.25rem"
    icon="{serverState == 'running' ? 'stop' : 'start'}" >
    <event name="click">
      <ApiBinding 
        url="/server/action"
        method="post"
        body="{{ serverAction: (state == 'running') ? 'stop' : 'start' }}"
        inProgressNotificationMessage="{
          (serverState == 'running' ? 'Stopping' : 'Starting') + ' server ...'
        }"
        onSuccess="{ serverState = (serverState == 'running' ? '' : 'running') }"/>
    </event>
    {serverState == "running" ? "Stop" : "Start"}
  </Button>
  <Button 
    id="serverActionButton"
    type="button"
    horizontalMargin="0.25rem"
    icon="restart" >
    <event name="click">
      <ApiBinding 
        url="/server/action"
        method="post"
        body="{{ serverAction: 'restart' }}"
        onSuccess="(res) => { serverState = res === 'OK' ? 'running' : 'stopped' }"/>
    </event>
    Restart
  </Button>
  <Checkbox label="Run as service" id="runAsService" initialValue="false" padding="1rem" />
</Component>
```

> **Note**: You can break long lines into multiple ones, even attribute values. Check how the `inProgressNotificationMessage` attribute is used in the list above.

## 3. Add `inProgressNotification` to Restart

It is worth adding a notification to the Restart button:

```ueml copy {12}
<!-- Code omitted -->
<Button 
  id="serverActionButton"
  type="button"
  horizontalMargin="0.25rem"
  icon="restart" >
  <event name="click">
    <ApiBinding 
      url="/server/action"
      method="post"
      body="{{ serverAction: 'restart' }}"
      inProgressNotificationMessage="Restarting server ..."
      onSuccess="(res) => { serverState = res === 'OK' ? 'running' : 'stopped' }"/>
  </event>
  Restart
</Button>
<!-- Code omitted -->
```

## 4. Removing the unused space from the navigation panel

XMLUI has a theme variable, `width-navPanel-App`, for that purpose. You have to set it up in the `deafult.ts` theme file:

```ts copy {15}
export const Default: ThemeDefinition = {
  name: "Default",
  id: "default",
  tone: "light",
  themeVars: {
    "color-bg-NavLinkIndicator": "transparent",
    "color-bg-NavLink--hover": "#e5e6e3",
    "color-bg-NavLink--active": "#E0E1DC",
    "color-bg-NavLink--pressed": "#E0E1DC",

    // --- App-specific
    "width-navPanel-App": "140px",

    // ...
  },
  resources: {
  },
};
```

## 5. Styling the header's background

We can easily change the header's background through theming. Add this theme variable to the `default.ts` theme file:

```ts copy {7}
export const Default: ThemeDefinition = {
  // ...
  themeVars: {
    // ...
    // --- App-specific
    "width-navPanel-App": "140px",
    "color-bg-AppHeader": "#e8e8e8",

    //...
  }
  // ...
};
```

## 6. Making buttons smaller

You can use the `size` attribute of buttons to make them smaller:

```ueml copy {3}
<Button 
  id="serverActionButton"
  size="xs"
  <!-- Omitted -->
</Button>
```

You can remove the spaces with layout properties, too:


```ueml copy {3-4}
<Button 
  id="serverActionButton"
  horizontalPadding="0.4rem"
  verticalPadding="0.2rem"
  <!-- Omitted -->
</Button>
```

However, the more layout properties we set directly, the more tedious style updates are. Instead, let's add a custom button component, and use them:

```ueml copy
<Component name="SftpHeaderButton">
  <Button
    horizontalPadding="$padding-horizontal-SftpHeaderButton"
    verticalPadding="$padding-vertical-SftpHeaderButton"
    enabled="{$props.enabled ?? true}"
    label="{$props.label}" 
    icon="{$props.icon}"
    onClick="() => $events.click()" />
</Component>
```

We add an `HStack` with `gap` and `verticalAlignment` to use a consistent layout: 

```ueml copy
<Component name="SftpHeader" var.serverState="">
  <HStack gap="0.5rem" verticalAlignment="center">
    <SftpHeaderButton 
      id="serverActionButton"
      label="{ serverState == 'running' ? 'Stop' : 'Start' }"
      icon="{serverState == 'running' ? 'stop' : 'start'}" >
      <event name="click">
        <ApiBinding 
          url="/server/action"
          method="post"
          body="{{ serverAction: (state == 'running') ? 'stop' : 'start' }}"
          inProgressNotificationMessage="{
            (serverState == 'running' ? 'Stopping' : 'Starting') + ' server ...'
          }"
          onSuccess="{ serverState = (serverState == 'running' ? '' : 'running') }"/>
      </event>
    </SftpHeaderButton>
    <SftpHeaderButton 
      id="serverActionButton"
      label="Restart"
      icon="restart" >
      <event name="click">
        <ApiBinding 
          url="/server/action"
          method="post"
          body="{{ serverAction: 'restart' }}"
          inProgressNotificationMessage="Restarting server ..."
          onSuccess="(res) => { serverState = res === 'OK' ? 'running' : 'stopped' }"/>
      </event>
    </SftpHeaderButton>
    <Checkbox label="Run as service" id="runAsService" initialValue="false" padding="1rem" />
  </HStack>
</Component>
```

Do not forget to set the theme variables in `default.ts`:

```ts copy {15}
export const Default: ThemeDefinition = {
  // ...
  themeVars: {
    // ...
    "padding-horizontal-SftpHeaderButton": "0.4rem",
    "padding-vertical-SftpHeaderButton": "0.2rem",
    // ...
  },
  // ...
};
```

## 7. Using buttons with predefined size

We can create a custom button that has a predefined (through theme variables) width and height:

```ueml copy
<Component name="SftpButton">
  <Button
    width="$width-SftpButton"
    height="$height-SftpButton"
    enabled="{$props.enabled ?? true}"
    label="{$props.label}" 
    onClick="() => $events.click()" />
</Component>
```

Add the related theme variables to the `default.ts` theme file:

```ts copy {15}
export const Default: ThemeDefinition = {
  // ...
  themeVars: {
    // ...
    // --- SftpButton-specific
    "width-SftpButton": "120px",
    "height-SftpButton": "32px",
    // ...
  },
  // ...
};
```

Change the buttons in `Users.xmlui` accordingly:

```ueml copy
<Component name="Users">
 <VStack padding="1rem">
  <VStack gap=".5rem" marginBottom="1rem" padding="1rem">
    <HStack gap=".5rem">
      <SftpButton label="Refresh" />
      <SftpButton label="New User"/>
      <SftpButton label="New Group" />
      <SftpButton label="Edit" enabled="false"/>
      <SftpButton label="Delete" enabled="false" size="xs" />
      <SftpButton label="Enable" enabled="false" size="xs" />
      <SftpButton label="Disable" enabled="false" size="xs" />
    </HStack>
  </VStack>
  <!-- Omitted -->
 </VStack>
</Component>
```

## 8. Fixing the `ConfirmDisconnect` bug

There is a bug in the `SessionManagement` component with the usage of `ConfirmDisconnect`:

```ueml copy {14}
<Component name="SessionManagement">
  <VStack padding="1rem">
    <Stack>Session management allows you to view and disconnect cliens</Stack>
    <Stack><Checkbox label="Enable Session Management" id="enableSessionManagement" initialValue="true" paddingTop="1rem" /></Stack>
    <Stack padding="1rem"  marginTop="1rem" backgroundColor="white" when="{enableSessionManagement.value}">
      <Table datasource="/sessions">
        <TableColumnDef header="User" size="140px" accessorKey="address" />
        <TableColumnDef header="Display Name" accessorKey="user" />
        <TableColumnDef header="Connection Time" accessorKey="connectionTime" />
        <TableColumnDef header="Action">
          <Button label="Disconnect" size="xs" 
            onClick="{Actions.navigate('.', {address: $item.address, confirmDisconnect: true})}" />
          <ConfirmDisconnect when="{$queryParams.confirmDisconnect !== undefined}" address="{address}" />
        </TableColumnDef>
      </Table>
    </Stack>
  </VStack>
</Component>
```

The bug's nature is that it displays as many modal dialogs over each other as table rows. You can see this as those overlayed dialogs result in an almost black backdrop instead of a slightly transparent one.

You should display the dialog only for an item with a particular address:

```ueml copy {6-9}
<!-- Omitted-->
<TableColumnDef header="Action">
  <Button label="Disconnect" size="xs" 
    onClick="{Actions.navigate('.', {address: $item.address, confirmDisconnect: true})}" />
  <ConfirmDisconnect 
    when="{
      $queryParams.confirmDisconnect !== undefined 
      && $queryParams.address === $item.address
    }"
    address="{address}" />
</TableColumnDef>
<!-- Omitted -->
```

As `ConfirmDisconnect` does not use the `address` parameter (this value is conveyed through a query parameter), we can refactor the markup into a more straightforward form, extracting `ConfimDisconnect` out of the `Table`:

```ueml copy {16}
<Component name="SessionManagement">
  <VStack padding="1rem">
    <Stack>Session management allows you to view and disconnect cliens</Stack>
    <Stack><Checkbox label="Enable Session Management" id="enableSessionManagement" initialValue="true" paddingTop="1rem" /></Stack>
    <Stack padding="1rem"  marginTop="1rem" backgroundColor="white" when="{enableSessionManagement.value}">
      <Table datasource="/sessions">
        <TableColumnDef header="User" size="140px" accessorKey="address" />
        <TableColumnDef header="Display Name" accessorKey="user" />
        <TableColumnDef header="Connection Time" accessorKey="connectionTime" />
        <TableColumnDef header="Action">
          <Button label="Disconnect" size="xs" onClick="{Actions.navigate('.', {address: $item.address, confirmDisconnect: true})}" />
        </TableColumnDef>
      </Table>
    </Stack>
  </VStack>
  <ConfirmDisconnect when="{$queryParams.confirmDisconnect !== undefined}" />
</Component>
```

## 9. Convert input forms to use `Form` and `FormItem`

*To be continued...*
